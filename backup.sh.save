#!/bin/bash

# ___ CREDITS
# This script started from 
#   http://raspberrypi.stackexchange.com/questions/5427/can-a-raspberry-pi-be-used-to-create-a-backup-of-itself
# which in turn started from 
#   http://www.raspberrypi.org/phpBB3/viewtopic.php?p=136912 
#
# 2013-Sept-04
# Merged in later comments from the original thread (the pv exists check modified) and added the backup.log
#
# 2013-Sept-05
# Remved tar compression, since it takes FOREVER to complete and I don't need it.
#
# Add an entry to crontab to run regurlarly.
# Example: Update /etc/crontab to run backup.sh as root every night at 3am
# 01 4    * * *   root    /home/pi/scripts/backup.sh

if [ "$(id -u)" != "0" ]; then
   echo "You must execute this script with root privileges" 1>&2
   exit 1
fi


function HELP
{
    echo 'HELP';
}

while getopts "h:o:b:cd:h::--help --output-dir --long-b --long-c --long-d --long-h" opt;  do
  case $opt in
    h)
	HELP
	exit 0
	;;
    o)
      DIR=$OPTARG
      echo "Selected output dir $DIR"
      ;
    \?) 
      echo -e \\n"Option -${BOLD}$OPTARG${NORM} not allowed."
      #If you just want to display a simple error message instead of the full
      #help, remove the 2 lines above and uncomment the 2 lines below.
      #echo -e "Use ${BOLD}$SCRIPT -h${NORM} to see the help documentation."\\n
      #exit 2
      ;;
  esac
done

exit;

# Check if backup directory exists
if [ ! -d "$DIR" ];
   then
      mkdir -p $DIR
      echo "Backup directory $DIR doesn't exist, created it now!" >> $DIR/backup.log
fi

echo "____ BACKUP ON $(date +%Y/%m/%d_%H:%M:%S)" >> $DIR/backup.log
echo "Starting RaspberryPI backup process!" >> $DIR/backup.log

# First check if pv package is installed, if not, install it first
if `dpkg -s pv | grep -q Status;`
   then
      echo "Package 'pv' is installed." >> $DIR/backup.log
   else
      echo "Package 'pv' is NOT installed." >> $DIR/backup.log
      echo "Installing package 'pv'. Please wait..." >> $DIR/backup.log
      apt-get -y install pv
fi



# Create a filename with datestamp for our current backup (without .img suffix)
OFILE="$DIR/backup_$(date +%Y%m%d_%H%M%S)"

# Create final filename, with suffix
OFILEFINAL=$OFILE.img

# First sync disks
sync; sync

# Shut down some services before starting backup process
echo "Stopping some services before backup." >> $DIR/backup.log
nginx -s stop
service couchdb stop
service cron stop

# Begin the backup process, should take about 1 hour from 8Gb SD card to HDD
echo "Backing up SD card to USB HDD." >> $DIR/backup.log
echo "This will take some time depending on your SD card size and read performance. Please wait..." >> $DIR/backup.log
SDSIZE=`blockdev --getsize64 /dev/mmcblk0`;
pv -tpreb /dev/mmcblk0 -s $SDSIZE | dd of=$OFILE bs=1M conv=sync,noerror iflag=fullblock

# Wait for DD to finish and catch result
RESULT=$?

# Start services again that where shutdown before backup process
echo "Start the stopped services again." >> $DIR/backup.log
service cron start
service couchdb start
nginx

# If command has completed successfully, delete previous backups and exit
if [ $RESULT = 0 ];
   then
      echo "Successful backup, previous backup files will be deleted." >> $DIR/backup.log
      rm -f $DIR/backup_*.img
      mv $OFILE $OFILEFINAL
      # echo "Backup is being tarred. Please wait..." >> $DIR/backup.log
      # tar zcf $OFILEFINAL.tar.gz $OFILEFINAL
      # rm -rf $OFILEFINAL
      echo "RaspberryPI backup process completed! FILE: $OFILEFINAL" >> $DIR/backup.log
      echo "____ BACKUP SCRIPT FINISHED $(date +%Y/%m/%d_%H:%M:%S)" >> $DIR/backup.log
      exit 0
# Else remove attempted backup file
   else
      echo "Backup failed! Previous backup files untouched." >> $DIR/backup.log
      echo "Please check there is sufficient space on the HDD." >> $DIR/backup.log
      rm -f $OFILE
      echo "RaspberryPI backup process failed!" >> $DIR/backup.log
      echo "____ BACKUP SCRIPT FINISHED $(date +%Y/%m/%d_%H:%M:%S)" >> $DIR/backup.log
      exit 1
fi


